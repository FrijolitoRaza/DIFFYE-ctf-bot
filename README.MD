# DIFFYE-CTF Bot ğŸ”

Bot de Telegram para el CTF (Capture The Flag) de BÃºsqueda y Captura de Fugitivos.

## ğŸ“‹ DescripciÃ³n

Este bot gestiona un CTF temÃ¡tico donde los participantes deben resolver 5 desafÃ­os relacionados con anÃ¡lisis de informaciÃ³n para simular la captura de un fugitivo. Los desafÃ­os incluyen anÃ¡lisis de:
- Registros de E-commerce
- Registros telefÃ³nicos
- CÃ¡maras de trÃ¡nsito
- Redes sociales
- IntegraciÃ³n de fuentes

## ğŸš€ CaracterÃ­sticas

- **GestiÃ³n de usuarios**: Registro y seguimiento de participantes
- **Sistema de desafÃ­os**: 5 desafÃ­os + 1 tutorial, liberados por dÃ­a
- **ValidaciÃ³n de flags**: Sistema robusto de verificaciÃ³n de respuestas
- **Ranking en tiempo real**: Tabla de posiciones actualizada
- **EstadÃ­sticas detalladas**: Para usuarios y administradores
- **Base de datos PostgreSQL**: Almacenamiento persistente con **pool de conexiones**
- **Operaciones asÃ­ncronas**: Mejor rendimiento y escalabilidad
- **Rate limiting**: ProtecciÃ³n contra spam y ataques
- **Logging avanzado**: Sistema de logs rotativo y estructurado
- **Health checks**: Monitoreo automÃ¡tico del sistema
- **Variables de entorno**: ConfiguraciÃ³n flexible
- **Docker ready**: Despliegue containerizado optimizado

## ğŸ“… Fechas del Evento

Por defecto: **15/09 al 19/09**
(Modificables via variables de entorno para pruebas)

## ğŸ› ï¸ Requisitos

- Python 3.9+
- PostgreSQL 12+
- Token de Bot de Telegram (obtener de [@BotFather](https://t.me/botfather))
- Docker y Docker Compose (opcional, para despliegue containerizado)

## âš¡ Optimizaciones Implementadas

Este bot ha sido **completamente optimizado** para mejor rendimiento y escalabilidad:

### ğŸš€ Mejoras de Rendimiento
- **Pool de conexiones PostgreSQL**: ReutilizaciÃ³n eficiente de conexiones (5-20 por defecto)
- **Operaciones asÃ­ncronas**: Todas las operaciones de BD son no bloqueantes
- **Context managers**: GestiÃ³n automÃ¡tica de recursos
- **Health checks**: Monitoreo automÃ¡tico del sistema

### ğŸ›¡ï¸ Mejoras de Seguridad
- **SanitizaciÃ³n de input**: PrevenciÃ³n de inyecciones SQL
- **Rate limiting configurable**: ProtecciÃ³n contra spam
- **ValidaciÃ³n robusta**: VerificaciÃ³n de formato de flags
- **Logging estructurado**: Trazabilidad completa de operaciones

### ğŸ“Š Monitoreo Avanzado
- **MÃ©tricas detalladas**: EstadÃ­sticas en tiempo real
- **Logs rotativos**: GestiÃ³n automÃ¡tica de archivos de log
- **Alertas de salud**: DetecciÃ³n temprana de problemas

Para mÃ¡s detalles, consulta [OPTIMIZATIONS.md](OPTIMIZATIONS.md).

## ğŸ“¦ InstalaciÃ³n

### OpciÃ³n 1: InstalaciÃ³n Local Optimizada

1. **Clonar el repositorio**
```bash
git clone https://github.com/FrijolitoRaza/DIFFYE-ctf-bot.git
cd diffye-ctf-bot
```

2. **Crear entorno virtual**
```bash
python -m venv venv
source venv/bin/activate  # En Windows: venv\Scripts\activate
```

3. **ConfiguraciÃ³n optimizada automÃ¡tica**
```bash
# Copiar archivo de configuraciÃ³n
cp env.example .env

# Editar configuraciÃ³n (opcional)
nano .env

# Ejecutar configuraciÃ³n optimizada
python setup_optimized.py
```

4. **Instalar dependencias**
```bash
pip install -r requirements.txt
```

5. **Configurar PostgreSQL**
```bash
# La configuraciÃ³n se hace automÃ¡ticamente con setup_optimized.py
# Si necesitas configuraciÃ³n manual:
createdb diffye_ctf
psql -d diffye_ctf -f database_schema.sql
```

6. **Probar optimizaciones (opcional)**
```bash
python test_optimizations.py
```

7. **Ejecutar el bot optimizado**
```bash
python bot.py
```

### OpciÃ³n 2: Usando Docker

1. **Clonar el repositorio**
```bash
git clone https://github.com/FrijolitoRaza/DIFFYE-ctf-bot.git
cd diffye-ctf-bot
```

2. **Configurar variables de entorno**
```bash
cp .env.example .env
# Editar .env con tus valores
```

3. **Construir y ejecutar con Docker Compose**
```bash
# Modo producciÃ³n
docker-compose up -d

# Modo desarrollo (incluye PgAdmin)
docker-compose --profile dev up -d
```

## ğŸ¤– Comandos del Bot

### Comandos de Usuario
- `/start` - Iniciar el bot
- `/register` - Registrarse en el CTF
- `/challenges` - Ver desafÃ­os disponibles
- `/submit` - Enviar una flag
- `/progress` - Ver tu progreso personal
- `/leaderboard` - Ver el ranking general
- `/help` - Mostrar ayuda

### Comandos de Admin
- `/admin_stats` - Ver estadÃ­sticas generales (solo admins)
- `/broadcast` - Enviar mensaje circular (solo admins)

## ğŸ Flags y DesafÃ­os

### Formato de Flags
Todas las flags siguen el formato: `FLAG{RESPUESTA}`

### DesafÃ­os Disponibles

1. **DesafÃ­o 0 (Tutorial)**
   - Flag: `FLAG{INICIO_INVESTIGACION}`
   - Disponible: Siempre

2. **DesafÃ­o 4**: Redes Sociales
   - Flag: `FLAG{VILLA_URQUIZA}`
   - Disponible: DÃ­a 4 (18/09)

3. **DesafÃ­o 3**: CÃ¡maras de TrÃ¡nsito
   - Flag: `FLAG{TRIUNVIRATO_OLAZABAL}`
   - Disponible: DÃ­a 3 (17/09)

4. **DesafÃ­o 2**: Registros TelefÃ³nicos
   - Flag: `FLAG{CABALLITO}`
   - Disponible: DÃ­a 2 (16/09)

5. **DesafÃ­o 1**: AnÃ¡lisis de E-commerce
   - Flag: `FLAG{VENTA_ESTUPEFACIENTES}`
   - Disponible: DÃ­a 1 (15/09)

6. **DesafÃ­o 5**: La ConexiÃ³n Final
   - Flag: `FLAG{MAHALO_HERMANOS}`
   - Disponible: DÃ­a 5 (19/09)

## ğŸ”§ ConfiguraciÃ³n

### Variables de Entorno Principales

```env
# Bot de Telegram
BOT_TOKEN=tu_token_aqui

# Base de datos
DATABASE_URL=postgresql://user:pass@localhost:5432/diffye_ctf

# Administradores (IDs de Telegram)
ADMIN_IDS=123456789,987654321

# Fechas del evento (formato YYYY-MM-DD)
START_DATE=2024-09-15
END_DATE=2024-09-19

# Timezone
TIMEZONE=America/Argentina/Buenos_Aires

# Fechas del evento (formato: YYYY-MM-DD)
START_DATE=2024-09-15
END_DATE=2024-09-19

# ConfiguraciÃ³n de logging
LOG_LEVEL=INFO
LOG_FILE=logs/bot.log

# ConfiguraciÃ³n de rate limiting
RATE_LIMIT_MAX_CALLS=10
RATE_LIMIT_PERIOD=60


# Link de material para desafios
DESAFIO1= 

DESAFIO2=

DESAFIO3=

DESAFIO4=

DESAFIO5=

IMGFINAL=
```

## ğŸ“Š Base de Datos

### Esquema Principal

- **users**: InformaciÃ³n de usuarios registrados
- **progress**: Intentos y flags enviadas
- **statistics**: EstadÃ­sticas agregadas por usuario
- **activity_logs**: Log de todas las actividades
- **sessions**: Sesiones de participaciÃ³n

### Vistas Ãštiles

- **leaderboard_view**: Ranking con estadÃ­sticas
- **challenge_statistics**: EstadÃ­sticas por desafÃ­o

## ğŸ³ Docker

### Servicios Incluidos

- **postgres**: Base de datos PostgreSQL
- **bot**: AplicaciÃ³n del bot
- **pgadmin**: Interfaz web para PostgreSQL (perfil dev)
- **redis**: Cache y rate limiting (perfil production)
- **nginx**: Servidor web para archivos estÃ¡ticos (perfil production)

### Comandos Docker Ãštiles

```bash
# Ver logs del bot
docker-compose logs -f bot

# Acceder a la base de datos
docker-compose exec postgres psql -U diffye_user -d diffye_ctf

# Reiniciar el bot
docker-compose restart bot

# Backup de la base de datos
docker-compose exec postgres pg_dump -U diffye_user diffye_ctf > backup.sql
```

## ğŸ”’ Seguridad

### Mejores PrÃ¡cticas

1. **Nunca commitear el archivo `.env`** con credenciales reales
2. **Usar contraseÃ±as fuertes** para la base de datos
3. **Limitar IDs de admin** solo a usuarios confiables
4. **Configurar HTTPS** para nginx en producciÃ³n
5. **Realizar backups regulares** de la base de datos
6. **Monitorear logs** para detectar actividad sospechosa

### Rate Limiting

El bot incluye protecciÃ³n contra spam:
- MÃ¡ximo 10 intentos por desafÃ­o por usuario
- Cooldown de 5 minutos entre intentos fallidos mÃºltiples

## ğŸ“ˆ Monitoreo y EstadÃ­sticas

### Para Administradores

El comando `/admin_stats` muestra:
- Total de usuarios registrados
- Usuarios activos en las Ãºltimas 24h
- Completados por desafÃ­o
- Tasa de Ã©xito general

### Logs

Los logs se almacenan en:
- `./logs/` - Logs de aplicaciÃ³n
- PostgreSQL - Logs de actividad en `activity_logs`

## ğŸ§ª Testing

### Modo de Prueba

Para realizar pruebas fuera de las fechas oficiales:

1. Modificar las fechas en `.env`:
```env
START_DATE=2024-01-01
END_DATE=2024-12-31
```

2. Usar el DesafÃ­o 0 (Tutorial) que siempre estÃ¡ disponible

### Tests Automatizados

```bash
# Ejecutar tests
pytest tests/

# Con coverage
pytest --cov=. tests/
```

## ğŸ“ PersonalizaciÃ³n

### Modificar DesafÃ­os

Editar el diccionario `CHALLENGES` en `bot.py`:

```python
CHALLENGES = {
    1: {
        'title': 'Nuevo DesafÃ­o',
        'description': 'DescripciÃ³n...',
        'flag': 'FLAG{RESPUESTA}',
        'available_date': START_DATE,
        'material_link': 'https://...'
    }
}
```

### Agregar Materiales

1. Colocar archivos en `./materials/`
2. Actualizar `material_link` en el desafÃ­o correspondiente
3. Si usas nginx, los archivos estarÃ¡n disponibles en `http://tu-servidor/materials/`

## ğŸš¨ Troubleshooting

### Problemas Comunes

**Bot no responde:**
- Verificar token en `.env`
- Verificar conexiÃ³n a Internet
- Revisar logs: `docker-compose logs bot`

**Error de base de datos:**
- Verificar credenciales en `DATABASE_URL`
- Verificar que PostgreSQL estÃ© ejecutÃ¡ndose
- Revisar permisos de usuario

**DesafÃ­os no disponibles:**
- Verificar fechas en `.env`
- Verificar timezone configurado
- Verificar fecha/hora del sistema

**Rate limit exceeded:**
- Esperar el tiempo de cooldown
- Verificar configuraciÃ³n en `.env`

## ğŸ“š Estructura del Proyecto

```
diffye-ctf-bot/
â”œâ”€â”€ bot.py                 # AplicaciÃ³n principal
â”œâ”€â”€ requirements.txt       # Dependencias Python
â”œâ”€â”€ .env.example          # Ejemplo de configuraciÃ³n
â”œâ”€â”€ .gitignore           # Archivos ignorados por git
â”œâ”€â”€ database_schema.sql  # Esquema de base de datos
â”œâ”€â”€ docker-compose.yml   # ConfiguraciÃ³n Docker
â”œâ”€â”€ Dockerfile          # Imagen Docker del bot
â”œâ”€â”€ README.md          # Este archivo
â”œâ”€â”€ logs/             # Logs de aplicaciÃ³n
â”œâ”€â”€ materials/        # Archivos para desafÃ­os
â””â”€â”€ backups/         # Backups de base de datos
```

## ğŸ¤ Contribuciones

Las contribuciones son bienvenidas! Por favor:

1. Fork el proyecto
2. Crea una rama para tu feature (`git checkout -b feature/AmazingFeature`)
3. Commit tus cambios (`git commit -m 'Add some AmazingFeature'`)
4. Push a la rama (`git push origin feature/AmazingFeature`)
5. Abre un Pull Request

## ğŸ“„ Licencia

Este proyecto estÃ¡ bajo la Licencia MIT - ver el archivo [LICENSE](LICENSE) para detalles.

## ğŸ‘¥ CrÃ©ditos

- **Desarrollo**: [Tu nombre]
- **Concepto**: Curso de BÃºsqueda y Captura de Fugitivos
- **Framework**: python-telegram-bot

## ğŸ“ Soporte

Para soporte y consultas:
- Crear un issue en GitHub
- Contactar a los administradores del CTF
- Telegram: @tu_usuario

## ğŸ¯ Roadmap

### VersiÃ³n 1.0 (Actual)
- âœ… Sistema bÃ¡sico de desafÃ­os
- âœ… Registro y tracking de usuarios
- âœ… ValidaciÃ³n de flags
- âœ… Ranking en tiempo real
- âœ… Docker support

### VersiÃ³n 2.0 (Futuro)
- [ ] Sistema de hints (pistas) con penalizaciÃ³n
- [ ] DesafÃ­os dinÃ¡micos por equipo
- [ ] Dashboard web para administradores
- [ ] IntegraciÃ³n con plataforma CTF externa
- [ ] Notificaciones automÃ¡ticas
- [ ] ExportaciÃ³n de reportes en PDF
- [ ] Sistema de badges/logros
- [ ] Multi-idioma support

---

**Â¡Buena suerte en la investigaciÃ³n!** ğŸ•µï¸â€â™‚ï¸ğŸ”
**Â¡Buena suerte en la investigaciÃ³n!** ğŸ•µï¸â€â™‚ï¸ğŸ”